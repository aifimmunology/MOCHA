#' @title \code{addDelta}
#'
#' @description \code{addDelta} will add a new condition to the SummarizedExperiment output of extractRegion, 
#' 								which will contain the difference in accessibility between two conditions
#'
#' @param CountSE The SummarizedExperiment object output from extractRegion
#' @param foreground Group that will be used as the foreground for the substraction of accessibility
#' @param background Group that will be used as the background for the subtraction of accessibility
#' @param DeltaName The name given to the new assay that is difference in accessibility between foreground and background. 
#'
#' @return countSE a SummarizedExperiment containing coverage for the given input cell populations.
#'
#' @examples
#' \dontrun{
#' # CountSE is a SummarizedExperiment generated by extractRegion()
#' countSE <- scMACS::addDelta(
#'   CountSE = CountSE, 
#'   foreground = 'Condition1',
#'   background = 'Condition2',
#' 	 DeltaName = 'AccessibilityChanges'
#' )
#' }
#' @export
#'

addDelta <- function(CountSE, 
                          foreground, 
                          background,
						  DeltaName = NULL) {
  groupNames <- names(SummarizedExperiment::assays(CountSE))
  
  
  if(is.null(DeltaName)){
  
	DeltaName <- paste("Delta:", foreground, "-", background, sep = "")
  
  }
  
  metaFile <- SummarizedExperiment::colData(CountSE)
  outDir <- CountSE@metadata$Directory

  if (is.na(outDir)) {
    stop("Error: Missing coverage file directory.")
  }

  if (!all(c(foreground, background) %in% groupNames)) {
  
	stop("Error: Foreground & Background are not found. Try running names(assays(CountSE)) to verify all options")
  
  }else if(DeltaName %in% groupNames){
  
	stop('Error: The name of this differential is already present in the CountSE object. Try setting a different name via DeltaName')
  
  }else{
  
	fore <- assays(CountSE)[[foreground]]
	back <- assays(CountSE)[[background]]
  
	if( all(fore$chr == back$chr & fore$Locus == back$Locus)){
	
		delta <- data.frame(chr = fore$chr, Locus = fore$Locus, 
						Counts = fore$Counts - back$Counts,
						Groups = rep(DeltaName, length(fore$Counts)))
						
		assays(CountSE) <- append(assays(CountSE), list(DeltaName = delta))

		return(CountSE)
		
	}else{
	
		stop("Error: CountSE data frame is inconsistent. Likely there is an error in extractRegion, and the chr/locus don't align across conditions")
	
	}
	
  }
}
